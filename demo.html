<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Diamond Clarity Demo — LG689561771</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,600;1,300&family=Outfit:wght@200;300;400;500&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
:root {
  --gold: #c9a96e; --gold-light: #e8d5a8; --gold-dim: #8a7044;
  --ink: #0a0a0f; --pearl: #f0ede6;
  --glass: rgba(255,255,255,0.04); --glass-border: rgba(201,169,110,0.15);
  --glass-solid: rgba(255,255,255,0.06);
}
html, body { width:100%; height:100%; overflow:hidden; background:var(--ink);
  font-family:'Outfit',sans-serif; color:var(--pearl); -webkit-font-smoothing:antialiased; }

.atmosphere {
  position:fixed; inset:0; z-index:0; pointer-events:none;
  background:
    radial-gradient(ellipse 80% 60% at 50% 55%, rgba(30,28,50,0.8) 0%, transparent 70%),
    radial-gradient(ellipse 50% 40% at 50% 45%, rgba(90,70,140,0.12) 0%, transparent 60%),
    linear-gradient(180deg, #06060c 0%, #0d0d18 40%, #0a0a12 100%);
}
.grain {
  position:fixed; inset:-50%; width:200%; height:200%;
  z-index:999; pointer-events:none; opacity:0.03;
  background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E");
}
.corner-line { position:fixed; z-index:10; pointer-events:none; }
.corner-line--tl { top:20px; left:20px; width:36px; height:36px; border-top:1px solid var(--glass-border); border-left:1px solid var(--glass-border); }
.corner-line--br { bottom:20px; right:20px; width:36px; height:36px; border-bottom:1px solid var(--glass-border); border-right:1px solid var(--glass-border); }

/* Topbar */
.topbar {
  position:fixed; top:0; left:0; right:0; z-index:20;
  display:flex; align-items:center; justify-content:space-between;
  padding:20px 32px;
  background:linear-gradient(180deg, rgba(10,10,15,0.95) 0%, rgba(10,10,15,0.6) 70%, transparent 100%);
  pointer-events:none;
}
.topbar > * { pointer-events:auto; }
.logo { font-family:'Cormorant Garamond',serif; font-weight:300;
  font-size:13px; letter-spacing:0.35em; text-transform:uppercase; color:var(--gold); }
.logo span { color:var(--gold-dim); font-weight:400; }
.topbar-hint { font-size:10px; font-weight:300; letter-spacing:0.15em;
  color:rgba(240,237,230,0.2); text-transform:uppercase; }

/* Viewer */
.viewer { position:fixed; inset:0; z-index:1; }
.viewer canvas { width:100%!important; height:100%!important; display:block; }

/* Controls */
.viewer-controls {
  position:fixed; bottom:28px; left:50%; transform:translateX(-50%);
  display:flex; gap:6px; z-index:10;
}
.pill-btn {
  background:var(--glass); border:1px solid var(--glass-border);
  color:var(--pearl); font-family:'Outfit',sans-serif;
  font-size:10px; font-weight:400; letter-spacing:0.2em;
  text-transform:uppercase; padding:8px 16px; border-radius:2px;
  cursor:pointer; transition:all 0.3s ease; white-space:nowrap;
}
.pill-btn:hover { border-color:var(--gold); color:var(--gold-light); }
.glow-label { font-size:9px; font-weight:400; letter-spacing:0.2em;
  text-transform:uppercase; color:var(--gold-dim); margin-right:6px;
  line-height:28px; }
.brightness-slider {
  -webkit-appearance:none; appearance:none;
  width:80px; height:1px; background:var(--glass-border);
  outline:none; cursor:pointer; vertical-align:middle;
}
.brightness-slider::-webkit-slider-thumb {
  -webkit-appearance:none; width:10px; height:10px;
  border-radius:50%; background:var(--gold); border:none; cursor:pointer;
}

/* Grading overlay */
.grading-overlay {
  position:fixed; top:80px; right:32px; z-index:15;
  width:260px; padding:24px;
  background:var(--glass); border:1px solid var(--glass-border);
  border-radius:4px; backdrop-filter:blur(16px);
}
.shape-tag { display:inline-block; font-size:9px; font-weight:400;
  letter-spacing:0.3em; text-transform:uppercase; color:var(--gold);
  border:1px solid var(--glass-border); padding:4px 10px; border-radius:2px;
  background:var(--glass); margin-bottom:12px; }
.card-title { font-family:'Cormorant Garamond',serif; font-weight:300;
  font-size:24px; line-height:1.15; color:var(--pearl); margin-bottom:3px; }
.card-title em { font-style:italic; color:var(--gold-light); }
.card-subtitle { font-family:'Cormorant Garamond',serif; font-weight:300;
  font-style:italic; font-size:12px; color:rgba(240,237,230,0.3); margin-bottom:18px; }

.four-cs { display:grid; grid-template-columns:1fr 1fr; gap:2px; margin-bottom:16px; }
.c-item { background:var(--glass-solid); padding:10px 12px; border:1px solid var(--glass-border);
  display:flex; flex-direction:column; gap:3px; }
.c-item.hl { border-color:var(--gold); background:rgba(201,169,110,0.06); }
.c-label { font-size:8px; font-weight:400; letter-spacing:0.25em; text-transform:uppercase; color:var(--gold-dim); }
.c-value { font-family:'Cormorant Garamond',serif; font-size:22px; font-weight:400; color:var(--pearl); }

.section-head { font-size:8px; font-weight:400; letter-spacing:0.3em; text-transform:uppercase;
  color:var(--gold-dim); margin:14px 0 8px; padding-bottom:6px; border-bottom:1px solid var(--glass-border); }
.spec-row { display:flex; justify-content:space-between; margin-bottom:4px; }
.spec-label { font-size:10px; color:var(--gold-dim); letter-spacing:0.1em; }
.spec-value { font-family:'Cormorant Garamond',serif; font-size:14px; color:var(--pearl); }

/* Loader */
.loader-overlay {
  position:fixed; inset:0; z-index:100;
  display:flex; flex-direction:column; align-items:center; justify-content:center;
  background:var(--ink); transition:opacity 0.6s ease, visibility 0.6s ease;
}
.loader-overlay.hidden { opacity:0; visibility:hidden; pointer-events:none; }
.loader-diamond { width:36px; height:36px; border:1px solid var(--gold-dim);
  transform:rotate(45deg); animation:loaderPulse 1.6s ease-in-out infinite; position:relative; }
.loader-diamond::after { content:''; position:absolute; inset:5px; border:1px solid var(--gold);
  animation:loaderPulse 1.6s 0.3s ease-in-out infinite; }
.loader-text { margin-top:28px; font-size:10px; font-weight:300;
  letter-spacing:0.4em; text-transform:uppercase; color:var(--gold-dim);
  animation:loaderTextPulse 1.6s ease-in-out infinite; }

@keyframes loaderPulse {
  0%,100% { opacity:0.3; transform:rotate(45deg) scale(1); }
  50% { opacity:1; transform:rotate(45deg) scale(1.08); }
}
@keyframes loaderTextPulse { 0%,100% { opacity:0.4; } 50% { opacity:0.9; } }

@media (max-width:700px) {
  .grading-overlay { position:fixed; top:auto; bottom:0; right:0; left:0;
    width:100%; border-radius:8px 8px 0 0; max-height:40vh; overflow-y:auto; }
}
</style>
</head>
<body>

<div class="atmosphere"></div>
<div class="grain"></div>
<div class="corner-line corner-line--tl"></div>
<div class="corner-line corner-line--br"></div>

<div class="loader-overlay" id="loader">
  <div class="loader-diamond"></div>
  <div class="loader-text">Rendering diamond</div>
</div>

<div class="topbar">
  <div class="logo">Diamond <span>Clarity Demo</span></div>
  <div class="topbar-hint">Drag to rotate &middot; Scroll to zoom</div>
</div>

<div class="viewer" id="viewerPanel">
  <canvas id="diamond3d"></canvas>
</div>

<div class="viewer-controls">
  <button class="pill-btn" id="btnReset">Reset View</button>
  <span class="glow-label">Glow</span>
  <input type="range" class="brightness-slider" id="bloomSlider" min="0" max="2" step="0.05" value="0.25" />
</div>

<div class="grading-overlay" id="gradingOverlay">
  <div class="shape-tag" id="shapeTag">--</div>
  <div class="card-title" id="cardTitle">--</div>
  <div class="card-subtitle" id="cardSubtitle"></div>
  <div class="four-cs">
    <div class="c-item"><span class="c-label">Carat</span><span class="c-value" id="cCarat">--</span></div>
    <div class="c-item"><span class="c-label">Color</span><span class="c-value" id="cColor">--</span></div>
    <div class="c-item hl"><span class="c-label">Clarity</span><span class="c-value" id="cClarity">--</span></div>
    <div class="c-item"><span class="c-label">Cut</span><span class="c-value" id="cCut">--</span></div>
  </div>
  <div class="section-head">Measurements</div>
  <div id="specsContent"></div>
</div>

<script type="importmap">
{
  "imports": {
    "three": "https://cdn.jsdelivr.net/npm/three@0.162.0/build/three.module.js",
    "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.162.0/examples/jsm/",
    "three-mesh-bvh": "./node_modules/three-mesh-bvh/src/index.js"
  }
}
</script>

<script type="module">
import * as THREE from 'three';
import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
import { RGBELoader } from 'three/addons/loaders/RGBELoader.js';
import { RoomEnvironment } from 'three/addons/environments/RoomEnvironment.js';
import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';
import { OutputPass } from 'three/addons/postprocessing/OutputPass.js';
import { createDiamondGeometry, classifyShape } from './diamond-geometry.js';
import { createDiamondMaterial } from './diamond-material.js';

const REPORT_NUM = 'LG689561771';
const BASE = `reports/${REPORT_NUM}/`;

// ── Load report JSON ──
const raw = await fetch(BASE + REPORT_NUM + '.json').then(r => r.json());

// ── Transform raw IGI data to the format diamond-geometry.js expects ──
function parseReport(r) {
  // Parse measurements "6.68 x 5.46 x 3.65 mm"
  const mParts = (r['Measurements'] || '').match(/[\d.]+/g) || [];
  const length_mm = parseFloat(mParts[0]) || 6.5;
  const width_mm  = parseFloat(mParts[1]) || length_mm;
  const depth_mm  = parseFloat(mParts[2]) || 0;

  const pf = s => parseFloat((s || '').match(/[\d.]+/)?.[0]) || 0;

  return {
    report_number: r['REPORT NUMBER'],
    shape: r['SHAPE AND CUT'] || '',
    carat: r['CARAT WEIGHT'] || '',
    color_grade: r['COLOR GRADE'] || '',
    clarity_grade: r['CLARITY GRADE'] || '',
    cut_grade: r['CUT GRADE'] || '',
    polish: r['POLISH'] || '',
    symmetry: r['SYMMETRY'] || '',
    fluorescence: r['FLUORESCENCE'] || '',
    issue_date: r['REPORT DATE'] || '',
    length_mm, width_mm, depth_mm,
    measurements_mm: r['Measurements'] || '',
    proportions: {
      table_pct: pf(r['Table Size']),
      crown_height_pct: pf(r['Crown Height']),
      pavilion_depth_pct: pf(r['Pavilion Depth']),
      total_depth_pct: pf(r['Total Depth']),
      girdle: r['Girdle Thickness'] || '',
      culet: r['Culet'] || '',
    },
  };
}

const data = parseReport(raw);

// ── Populate grading overlay ──
const shapeParts = data.shape.split(' ');
const cap = s => s ? s.charAt(0).toUpperCase() + s.slice(1).toLowerCase() : '';
document.getElementById('shapeTag').textContent = raw['DESCRIPTION'] || 'DIAMOND';
document.getElementById('cardTitle').innerHTML =
  `${cap(shapeParts[0])} <em>${shapeParts.slice(1).map(cap).join(' ')}</em>`;
document.getElementById('cardSubtitle').textContent =
  `${REPORT_NUM} \u00B7 ${data.issue_date}`;
document.getElementById('cCarat').textContent = data.carat;
document.getElementById('cColor').textContent = data.color_grade;
document.getElementById('cClarity').textContent = data.clarity_grade;
document.getElementById('cCut').textContent = data.cut_grade || 'N/A';

const specs = [
  ['Dimensions', data.measurements_mm],
  ['Table', raw['Table Size']], ['Depth', raw['Total Depth']],
  ['Polish', data.polish], ['Symmetry', data.symmetry],
];
document.getElementById('specsContent').innerHTML = specs.map(([l,v]) =>
  `<div class="spec-row"><span class="spec-label">${l}</span><span class="spec-value">${v || '--'}</span></div>`
).join('');

// ═══════════════════════════════════════
// THREE.JS SCENE
// ═══════════════════════════════════════

const canvas = document.getElementById('diamond3d');
const renderer = new THREE.WebGLRenderer({ canvas, antialias: true, alpha: true, powerPreference: 'high-performance' });
renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
renderer.toneMapping = THREE.ACESFilmicToneMapping;
renderer.toneMappingExposure = 1.0;
renderer.shadowMap.enabled = true;
renderer.shadowMap.type = THREE.PCFSoftShadowMap;

const scene = new THREE.Scene();
const camera = new THREE.PerspectiveCamera(35, 1, 0.1, 100);
camera.position.set(0, 6, 14);

// Bloom
const composer = new EffectComposer(renderer);
composer.addPass(new RenderPass(scene, camera));
const bloomPass = new UnrealBloomPass(new THREE.Vector2(1, 1), 0.25, 0.4, 0.85);
composer.addPass(bloomPass);
composer.addPass(new OutputPass());

document.getElementById('bloomSlider').addEventListener('input', e => {
  bloomPass.strength = parseFloat(e.target.value);
});

// HDRI environment
const pmremGenerator = new THREE.PMREMGenerator(renderer);
pmremGenerator.compileEquirectangularShader();

let cubeTexture = null;
const envReady = new Promise(resolve => {
  new RGBELoader().load(
    'https://dl.polyhaven.org/file/ph-assets/HDRIs/hdr/1k/aerodynamics_workshop_1k.hdr',
    texture => {
      texture.mapping = THREE.EquirectangularReflectionMapping;
      scene.environment = pmremGenerator.fromEquirectangular(texture).texture;
      const cubeRT = new THREE.WebGLCubeRenderTarget(256);
      cubeRT.fromEquirectangularTexture(renderer, texture);
      cubeTexture = cubeRT.texture;
      texture.dispose();
      pmremGenerator.dispose();
      resolve();
    },
    undefined,
    () => {
      console.warn('HDRI failed, using RoomEnvironment fallback');
      const roomScene = new RoomEnvironment(renderer);
      scene.environment = pmremGenerator.fromScene(roomScene, 0.04).texture;
      const cubeRT = new THREE.WebGLCubeRenderTarget(256);
      const cubeCamera = new THREE.CubeCamera(0.1, 100, cubeRT);
      cubeCamera.update(renderer, roomScene);
      cubeTexture = cubeRT.texture;
      roomScene.dispose();
      pmremGenerator.dispose();
      resolve();
    }
  );
});

// Controls
const controls = new OrbitControls(camera, canvas);
controls.enableDamping = true;
controls.dampingFactor = 0.05;
controls.autoRotate = true;
controls.autoRotateSpeed = 1.2;
controls.enablePan = false;
controls.minDistance = 5;
controls.maxDistance = 30;
controls.maxPolarAngle = Math.PI * 0.58;
controls.minPolarAngle = Math.PI * 0.15;
controls.target.set(0, 0, 0);

// Lighting
scene.add(new THREE.AmbientLight(0xffffff, 0.3));
const keyLight = new THREE.SpotLight(0xfff0dd, 60, 40, Math.PI / 5, 0.3, 1);
keyLight.position.set(5, 12, 6);
keyLight.castShadow = true;
keyLight.shadow.mapSize.set(1024, 1024);
keyLight.shadow.bias = -0.001;
scene.add(keyLight);

const fillLight = new THREE.PointLight(0xc8d8ff, 15, 30, 1.5);
fillLight.position.set(-6, 8, -4);
scene.add(fillLight);

const rimLight = new THREE.PointLight(0xffd080, 12, 25, 1.5);
rimLight.position.set(-3, 3, 8);
scene.add(rimLight);

const underLight = new THREE.PointLight(0x8888ff, 6, 15, 2);
underLight.position.set(0, -3, 0);
scene.add(underLight);

// Ground
const ground = new THREE.Mesh(
  new THREE.CircleGeometry(20, 64),
  new THREE.MeshStandardMaterial({ color: 0x080810, roughness: 0.2, metalness: 0.8, envMapIntensity: 0.3 })
);
ground.rotation.x = -Math.PI / 2;
ground.position.y = -3;
ground.receiveShadow = true;
scene.add(ground);

const gRing = new THREE.Mesh(
  new THREE.RingGeometry(1.5, 4.5, 64),
  new THREE.MeshStandardMaterial({ color: 0x151525, roughness: 0.05, metalness: 1.0, envMapIntensity: 0.5, transparent: true, opacity: 0.5 })
);
gRing.rotation.x = -Math.PI / 2;
gRing.position.y = -2.98;
scene.add(gRing);

// ── Build diamond ──
const geometry = createDiamondGeometry(data, THREE);
geometry.computeBoundingBox();
const size = new THREE.Vector3();
geometry.boundingBox.getSize(size);
const scale = 5 / Math.max(size.x, size.y, size.z);
geometry.scale(scale, scale, scale);

await envReady;

const { material } = createDiamondMaterial(THREE, geometry, cubeTexture, {
  bounces: 3, ior: 2.75, aberrationStrength: 0.01, fresnel: 1.0,
});
const mesh = new THREE.Mesh(geometry, material);
scene.add(mesh);

// Hide loader
document.getElementById('loader').classList.add('hidden');

// ── Resize ──
function resize() {
  const w = window.innerWidth;
  const h = window.innerHeight;
  camera.aspect = w / h;
  camera.updateProjectionMatrix();
  renderer.setSize(w, h);
  composer.setSize(w, h);
}
window.addEventListener('resize', resize);
resize();

// ── Controls ──
document.getElementById('btnReset').addEventListener('click', () => {
  camera.position.set(0, 4, 12);
  controls.target.set(0, 0, 0);
  controls.update();
});

// ── Animate ──
const clock = new THREE.Clock();
(function animate() {
  requestAnimationFrame(animate);
  mesh.position.y = Math.sin(clock.getElapsedTime() * 0.8) * 0.06;
  controls.update();
  composer.render();
})();
</script>
</body>
</html>
